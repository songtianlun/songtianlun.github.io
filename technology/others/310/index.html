<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>迁移 GitLab 小记 | Frytea</title><meta name=keywords content="GitLab"><meta name=description content="由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。 首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令： cat /opt/gitlab/embedded/service/gitlab-rails/VERSION 我的两个服务器输出分别是"><meta name=author content="Tianlun Song"><link rel=canonical href=https://www.frytea.com/technology/others/310/><meta name=yandex-verification content="73b1a797f62c0e98"><meta name=baidu-site-verification content="code-gnOrbP1RyC"><meta name=baidu_union_verify content="4c552c344295cb984c46ebe74962b067"><link crossorigin=anonymous href=/assets/css/stylesheet.min.9041f934b858852543829283d4d23654e5acebeca82afe810b803578807baa48.css integrity="sha256-kEH5NLhYhSVDgpKD1NI2VOWs6+yoKv6BC4A1eIB7qkg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script src=//staticfile-cdn.frytea.com/valine@1.5.1/dist/Valine.min.js></script><script type=text/javascript src=//staticfile-cdn.frytea.com/artitalk@3.3.4/artitalk.js></script><link rel=icon href=https://www.frytea.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.frytea.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.frytea.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.frytea.com/apple-touch-icon.png><link rel=mask-icon href=https://www.frytea.com/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><link rel=manifest href=/manifest.json><script src=https://staticfile-cdn.frytea.com/aplayer/1.10.1/APlayer.min.js></script><script src=https://staticfile-cdn.frytea.com/meting@2.0.1/dist/Meting.min.js></script><script type=text/javascript>function downloadJSAtOnload(){var a=document.createElement("script");a.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7296634171837358",document.body.appendChild(a)}window.addEventListener?window.addEventListener("load",downloadJSAtOnload,!1):window.attachEvent?window.attachEvent("onload",downloadJSAtOnload):window.onload=downloadJSAtOnload</script><script async defer data-website-id=3d947a98-2774-46b0-805f-fe2e4877a1d7 src=https://umami.frytea.com/umami.js></script><script async defer data-website-id=460b58e0-655d-42d7-926c-7a44aeb5730f src=https://frytea-umami.onrender.com/umami.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=//staticfile-cdn.frytea.com/font-awesome@4.3.0/css/font-awesome.min.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?c49e2f5be5e009382be07455c33b1394",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-136094326-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="迁移 GitLab 小记"><meta property="og:description" content="由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。 首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令： cat /opt/gitlab/embedded/service/gitlab-rails/VERSION 我的两个服务器输出分别是"><meta property="og:type" content="article"><meta property="og:url" content="https://www.frytea.com/technology/others/310/"><meta property="og:image" content="https://www.frytea.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="technology"><meta property="article:published_time" content="2020-02-06T19:30:00+00:00"><meta property="article:modified_time" content="2020-02-06T19:30:00+00:00"><meta property="og:site_name" content="Frytea"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.frytea.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="迁移 GitLab 小记"><meta name=twitter:description content="由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。 首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令： cat /opt/gitlab/embedded/service/gitlab-rails/VERSION 我的两个服务器输出分别是"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"技术文集","item":"https://www.frytea.com/technology/"},{"@type":"ListItem","position":2,"name":"迁移 GitLab 小记","item":"https://www.frytea.com/technology/others/310/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"迁移 GitLab 小记","name":"迁移 GitLab 小记","description":"由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。 首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令： cat /opt/gitlab/embedded/service/gitlab-rails/VERSION 我的两个服务器输出分别是","keywords":["GitLab"],"articleBody":"由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。\n首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令：\ncat /opt/gitlab/embedded/service/gitlab-rails/VERSION\r我的两个服务器输出分别是：\n# 迁入服务器\r$ cat /opt/gitlab/embedded/service/gitlab-rails/VERSION\r12.7.5-ee\r# 迁出服务器\r$ cat /opt/gitlab/embedded/service/gitlab-rails/VERSION\r12.5.2-ee\r升级 GitLab 因此需要对服务器进行升级。\n我采用的安装方法是 Omnibus, 采用官网推荐的方式进行升级：\n# Debian/Ubuntu\rsudo apt-get update\rsudo apt-get install gitlab-ce\r# Centos/RHEL\rsudo yum install gitlab-ce\r# 如果是 ee就修改为 ee\r其他升级方式可以来这里看：Updating GitLab installed with the Omnibus GitLab package\n打备份包 我采用的安装方法是 Omnibus, 采用官网推荐的方式进行打包：Creating a backup of the GitLab system\n$ sudo gitlab-backup create\r2020-02-06 10:23:21 +0000 -- Dumping database ...\rDumping PostgreSQL database gitlabhq_production ... [DONE]\r2020-02-06 10:23:23 +0000 -- done\r2020-02-06 10:23:23 +0000 -- Dumping repositories ...\r* songtianlun/journal (@hashed/6b/86/6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b) ... [SKIPPED]\r[SKIPPED] Wiki\r* songtianlun/Frytea-Timeline (@hashed/d4/73/d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/haut-gis-org-github-io (@hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/frytea-docs (@hashed/ef/2d/ef2d127de37b942baad06145e54b0c619a1f22327b2ebbcfbec78f5564afe39d) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/gatsby-starter-gine-blog (@hashed/e7/f6/e7f6c011776e8db7cd330b54174fd76f7d0216b612387a5ffcfb81e6f0919683) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/frytea-docs-ex (@hashed/79/02/7902699be42c8a8e46fbbb4501726517e86b22c56a189f7625a6da49081b2451) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Frytea-DataShare (@hashed/2c/62/2c624232cdd221771294dfbb310aca000a0df6ac8b66b696d90ef06fdefb64a3) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/markmap (@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Gis-SoDev-Expriment (@hashed/4a/44/4a44dc15364204a80fe80e9039455cc1608281820fe2b24f1e5233ade6af1dd5) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/jenkins-android-sample (@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Markdown-Syntax-CN (@hashed/6b/51/6b51d431df5d7f141cbececcf79edf3dd861c3b4069f0b11661a3eefacbba918) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/hexo-blog (@hashed/85/27/8527a891e224136950ff32ca212b45bc93f69fbb801c3b1ebedac52775f99e61) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Flash-Light (@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Image-Hosting (@hashed/45/23/4523540f1504cd17100c4835e85b7eefd49911580f8efff0599a8f283be6b9e3) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/vue_vue2leaflet (@hashed/4e/c9/4ec9599fc203d176a301536c2e091a19bc852759b255bd6818810a42c5fed14a) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/home-forward (@hashed/94/00/9400f1b21cb527d7fa3d3eabba93557a18ebe7a2ca4e471cfe5e4c5b4ca7f767) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/nodeppt (@hashed/f5/ca/f5ca38f748a1d6eaf726b8a42fb575c3c71f1864a8143301782de13da2d9202b) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/PathManager (@hashed/6f/4b/6f4b6612125fb3a0daecd2799dfd6c9c299424fd920f9b308110a2c1fbd8f443) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/perpetual-config (@hashed/78/5f/785f3ec7eb32f30b90cd0fcf3657d388b5ff4297f2f9716ff66e9b69c05ddd09) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/PathManager-Site (@hashed/53/5f/535fa30d7e25dd8a49f1536779734ec8286108d115da5045d77f3b4185d8f790) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/CuteOneP (@hashed/c2/35/c2356069e9d1e79ca924378153cfbbfb4d4416b1f99d41a2940bfdb66c5319db) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Education-manage-system (@hashed/b7/a5/b7a56873cd771f2c446d369b649430b65a756ba278ff97ec81bb6f55b2e73569) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/PL-indoor-RouteAnalyser (@hashed/5f/9c/5f9c4ab08cac7457e9111a30e4664920607ea2c115a1433d7be98e97e64244ca) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/ResumeSample (@hashed/67/06/670671cd97404156226e507973f2ab8330d3022ca96e0c93bdbdb320c41adcaf) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/programmer-url-navigation (@hashed/59/e1/59e19706d51d39f66711c2653cd7eb1291c94d9b55eb14bda74ce4dc636d015a) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/putianxi-github-io (@hashed/35/13/35135aaa6cc23891b40cb3f378c53a17a1127210ce60e125ccf03efcfdaec458) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/ci-matters (@hashed/62/4b/624b60c58c9d8bfb6ff1886c2fd605d2adeb6ea4da576068201b6c6958ce93f4) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/coding-interview-university (@hashed/eb/1e/eb1e33e8a81b697b75855af6bfcdbcbf7cbbde9f94962ceaec1ed8af21f5a50f) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/zhongguojinxiandaishishijianzhou (@hashed/e2/9c/e29c9c180c6279b0b02abd6a1801c7c04082cf486ec027aa13515e4f3884bb6b) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Web-Demo (@hashed/c6/f3/c6f3ac57944a531490cd39902d0f777715fd005efac9a30622d5f5205e7f6894) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/WebGis-SIC-Dev-Experiment (@hashed/86/e5/86e50149658661312a9e0b35558d84f6c6d3da797f552a9657fe0558ca40cdef) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/Small-Supermarket-manager-system (@hashed/9f/14/9f14025af0065b30e47e23ebb3b491d39ae8ed17d33739e5ff3827ffb3634953) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/sou (@hashed/76/a5/76a50887d8f1c2e9301755428990ad81479ee21c25b43215cf524541e0503269) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/songtianlun.pages.frytea.com (@hashed/7a/61/7a61b53701befdae0eeeffaecc73f14e20b537bb0f8b91ad7c2936dc63562b25) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/setup-node (@hashed/ae/a9/aea92132c4cbeb263e6ac2bf6c183b5d81737f179f21efdc5863739672f0f470) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/trajectory-community (@hashed/0b/91/0b918943df0962bc7a1824c0555a389347b4febdc7cf9d1254406d80ce44e3f9) ... [SKIPPED]\r[SKIPPED] Wiki\r* songtianlun/gis-changchun-info-vue (@hashed/d5/9e/d59eced1ded07f84c145592f65bdf854358e009c5cd705f5215bf18697fed103) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/PlanAssistant (@hashed/3d/91/3d914f9348c9cc0ff8a79716700b9fcd4d2f3e711608004eb8f138bcba7f14d9) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/materialistic (@hashed/71/ee/71ee45a3c0db9a9865f7313dd3372cf60dca6479d46261f3542eb9346e4a04d6) ... [DONE]\r[SKIPPED] Wiki\r* songtianlun/android-example (@hashed/81/17/811786ad1ae74adfdd20dd0372abaaebc6246e343aebd01da0bfc4c02bf0106c) ... [DONE]\r[SKIPPED] Wiki\r2020-02-06 10:23:46 +0000 -- done\r2020-02-06 10:23:46 +0000 -- Dumping uploads ...\r2020-02-06 10:23:47 +0000 -- done\r2020-02-06 10:23:47 +0000 -- Dumping builds ...\r2020-02-06 10:23:47 +0000 -- done\r2020-02-06 10:23:47 +0000 -- Dumping artifacts ...\r2020-02-06 10:23:50 +0000 -- done\r2020-02-06 10:23:50 +0000 -- Dumping pages ...\r2020-02-06 10:23:51 +0000 -- done\r2020-02-06 10:23:51 +0000 -- Dumping lfs objects ...\r2020-02-06 10:23:51 +0000 -- done\r2020-02-06 10:23:51 +0000 -- Dumping container registry images ...\r2020-02-06 10:23:51 +0000 -- [DISABLED]\rCreating backup archive: 1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar ... done\rUploading backup archive to remote storage ... skipped\rDeleting tmp directories ... done\rdone\rdone\rdone\rdone\rdone\rdone\rdone\rDeleting old backups ... skipping\rWarning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data\rand are not included in this backup. You will need these files to restore a backup.\rPlease back them up manually.\rBackup task is done.\r完成后就已经对 GitLab 整个系统备份到 /var/opt/gitlab/backups，根据官网除了打包还需要备份以下两个文件：\n /etc/gitlab/gitlab-secrets.json /etc/gitlab/gitlab.rb  因此将这个两个文件也拷入 backups 文件夹，以便后面打包迁移：\ncp /etc/gitlab/gitlab-secrets.json /var/opt/gitlab/backups/gitlab-secrets.json\rcp /etc/gitlab/gitlab.rb /var/opt/gitlab/backups/gitlab.rb\r完成后看一下 /var/opt/gitlab/backups 文件夹中就是我们需要迁移走的所有文件啦\n$ ls\r1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar gitlab.rb gitlab-secrets.json\r对它进行打包：\n# 打包后，以 gzip 压缩\r$ tar -zcvf /tmp/gitlab.2020.2.6.backups.tar.gz /var/opt/gitlab/backups\rtar: Removing leading `/' from member names\r/var/opt/gitlab/backups/\r/var/opt/gitlab/backups/gitlab.rb\r/var/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar\r/var/opt/gitlab/backups/gitlab-secrets.json\r安装 阿里云 ossutils 工具 在这里使用阿里云 oss 做中转，你也可使用其他方式将压缩包传入待转入服务器。\n首先安装：\n# 下载工具：\r$ wget http://gosspublic.alicdn.com/ossutil/1.6.10/ossutil64 # 修改文件执行权限：\r$ chmod 755 ossutil64\r# 使用交互式配置生成配置文件：\r$ ./ossutil64 config\r请输入配置文件名，文件名可以带路径（默认为：/home/user/.ossutilconfig，回车将使用默认路径。如果用户设置为其它路径，在使用命令时需要将--config-file选项设置为该路径）：\r未输入配置文件路径，将使用默认配置文件：/home/user/.ossutilconfig。\r对于下述配置，回车将跳过相关配置项的设置，配置项的具体含义，请使用\"help config\"命令查看。\r请输入endpoint：http://oss-cn-shenzhen.aliyuncs.com\r请输入accessKeyID：yourAccessKeyID\r请输入accessKeySecret：yourAccessKeySecret\r请输入stsToken：\r使用命令查看 endpoint,\n$ ./ossutil64 ls\rCreationTime Region StorageClass BucketName\r2020-02-06 06:06:37 +0000 UTC oss-cn-beijing Standard oss://frytea-temporary\r2019-01-12 01:59:01 +0000 UTC oss-cn-beijing Standard oss://mywebsites\r2019-11-12 06:47:12 +0000 UTC oss-cn-shenzhen Standard oss://onedrive-index\rBucket Number is: 3\r0.298487(s) elapsed\r上传\n$ ./ossutil64 cp /tmp/gitlab.2020.2.6.backups.tar.gz oss://frytea-temporary/gitlab/\rSucceed: Total num: 1, size: 558,098,855. OK num: 1(upload 1 files). 150.496710(s) elapsed\r接下来来到待迁入服务器，同样执行 安装  之后进行下载：\n$ ./ossutil64 cp oss://frytea-temporary/gitlab/gitlab.2020.2.6.backups.tar.gz ~\rSucceed: Total num: 1, size: 558,098,855. OK num: 1(download 1 objects). 10.706132(s) elapsed\r在这类迁入服务器是阿里云服务器，因此下载速度很快。\n还原备份 首先将下载好的文件夹解压：\n$ tar -zxvf gitlab.2020.2.6.backups.tar.gz\rvar/opt/gitlab/backups/\rvar/opt/gitlab/backups/gitlab.rb\rvar/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar\rvar/opt/gitlab/backups/gitlab-secrets.json\r压缩时保留了原有目录结构。\n将备份文件拷入迁入服务器的 /var/opt/gitlab/backups/ 文件夹：\nmv ~/var/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar /var/opt/gitlab/backups/\r下面停止 GitLab 中于数据库交换数据的 服务：\n$ sudo gitlab-ctl stop unicorn\rok: down: unicorn: 3188s, normally up\r$ sudo gitlab-ctl stop puma\r$ sudo gitlab-ctl stop sidekiq\rok: down: sidekiq: 3186s, normally up\r$ sudo gitlab-ctl status\rrun: alertmanager: (pid 23730) 4249s; run: log: (pid 23210) 4343s\rrun: gitaly: (pid 23585) 4252s; run: log: (pid 22585) 4451s\rrun: gitlab-exporter: (pid 23620) 4251s; run: log: (pid 23064) 4359s\rrun: gitlab-workhorse: (pid 23569) 4253s; run: log: (pid 22926) 4386s\rrun: grafana: (pid 23750) 4248s; run: log: (pid 23407) 4296s\rrun: logrotate: (pid 28170) 780s; run: log: (pid 22977) 4379s\rrun: nginx: (pid 23409) 4295s; run: log: (pid 22937) 4384s\rrun: node-exporter: (pid 23603) 4252s; run: log: (pid 23035) 4367s\rrun: postgres-exporter: (pid 23741) 4249s; run: log: (pid 23245) 4337s\rrun: postgresql: (pid 22682) 4446s; run: log: (pid 22731) 4443s\rrun: prometheus: (pid 23636) 4250s; run: log: (pid 23143) 4349s\rrun: redis: (pid 22520) 4458s; run: log: (pid 22535) 4457s\rrun: redis-exporter: (pid 23623) 4251s; run: log: (pid 23091) 4355s\rrun: registry: (pid 23578) 4252s; run: log: (pid 23018) 4371s\rdown: sidekiq: 3188s, normally up; run: log: (pid 22891) 4390s\rdown: unicorn: 3195s, normally up; run: log: (pid 22877) 4397s\r恢复备份：\n$ sudo gitlab-backup restore BACKUP=1580984631_2020_02_06_12.7.5-ee\r# 这里去掉备份名字的_gitlab_backup.tar\r# 以下是输出\rTransfering ownership of /var/opt/gitlab/gitlab-rails/shared/registry to git:git\rUnpacking backup ... done\rBefore restoring the database, we will remove all existing\rtables to avoid future upgrade problems. Be aware that if you have\rcustom tables in the GitLab database these tables and all data will be\rremoved.\rDo you want to continue (yes/no)? yes\rRemoving all tables. Press `Ctrl-C` within 5 seconds to abort\r2020-02-06 18:47:41 +0800 -- Cleaning the database ...\r2020-02-06 18:47:42 +0800 -- done\r2020-02-06 18:47:42 +0800 -- Restoring database ...\rRestoring PostgreSQL database gitlabhq_production ... SET\r...\rrake aborted!\rErrno::ENOENT: No such file or directory - /var/opt/gitlab/backups/registry.tar.gz\r/opt/gitlab/embedded/service/gitlab-rails/lib/backup/files.rb:76:in `run_pipeline!'\r/opt/gitlab/embedded/service/gitlab-rails/lib/backup/files.rb:44:in `restore'\r/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/backup.rake:234:in `block (4 levels) in '\r/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/backup.rake:71:in `block (3 levels) in '\r/opt/gitlab/embedded/bin/bundle:23:in `load'\r/opt/gitlab/embedded/bin/bundle:23:in `'\rTasks: TOP = gitlab:backup:registry:restore\r(See full trace by running task with --trace)\rTransfering ownership of /var/opt/gitlab/gitlab-rails/shared/registry to registry:registry\r将之前备份的另外两个文件迁入：\nmv /etc/gitlab/gitlab-secrets.json /etc/gitlab/gitlab-secrets.json.2020.2.6.backup\rmv /etc/gitlab/gitlab.rb /etc/gitlab/gitlab.rb.2020.2.6.backup\rmv ~/var/opt/gitlab/backups/gitlab-secrets.json /etc/gitlab/gitlab-secrets.json\rmv ~/var/opt/gitlab/backups/gitlab.rb /etc/gitlab/gitlab.rb\r重启 GitLab\nsudo gitlab-ctl reconfigure\rsudo gitlab-ctl restart\rsudo gitlab-rake gitlab:check SANITIZE=true\r完成！\n参考文献  如何查看 GitLab 版本号 Updating GitLab installed with the Omnibus GitLab package Backing up and restoring GitLab gitlab迁移 Linux下的解压命令小结 Linux tar打包命令 对象存储 OSS  常用工具  命令行工具ossutil  下载和安装  ","wordCount":"1967","inLanguage":"zh","datePublished":"2020-02-06T19:30:00Z","dateModified":"2020-02-06T19:30:00Z","author":{"@type":"Person","name":"Tianlun Song"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.frytea.com/technology/others/310/"},"publisher":{"@type":"Organization","name":"Frytea","logo":{"@type":"ImageObject","url":"https://www.frytea.com/favicon.ico"}}}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.frytea.com/ accesskey=h title="🏡 Frytea (Alt + H)">🏡 Frytea</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.frytea.com/categories/ title=🗂><span>🗂</span></a></li><li><a href=https://www.frytea.com/tags/ title=🏷️><span>🏷️</span></a></li><li><a href=https://www.frytea.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li><li><a href=https://www.frytea.com/posts/ title=🖋><span>🖋</span></a></li><li><a href=https://www.frytea.com/technology/ title=🛠><span>🛠</span></a></li><li><a href=https://www.frytea.com/shuoshuo/ title=📋><span>📋</span></a></li><li><a href=https://www.frytea.com/technology/projects/ title=📁><span>📁</span></a></li><li><a href=https://travellings.link title=🚇><span>🚇</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.frytea.com/>主页</a>&nbsp;»&nbsp;<a href=https://www.frytea.com/technology/>技术文集</a></div><h1 class=post-title><a href=https://www.frytea.com/technology/others/310/>迁移 GitLab 小记</a></h1><div class=post-meta>February 6, 2020&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1967 字&nbsp;·&nbsp;Tianlun Song&nbsp;|&nbsp;<a href=https://github.com/songtianlun/songtianlun.github.io/edit/main/content/technology/others/%e8%bf%81%e7%a7%bb-GitLab-%e5%b0%8f%e8%ae%b0.md rel="noopener noreferrer" target=_blank>PR</a>
<span id=/technology/others/310/ class=leancloud_visitors data-flag-title="迁移 GitLab 小记">&nbsp;| &nbsp;<span class=leancloud-visitors-count><i class="fa fa-spinner fa-spin"></i></span>&nbsp;Hits</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%8d%87%e7%ba%a7-gitlab aria-label="升级 GitLab">升级 GitLab</a></li><li><a href=#%e6%89%93%e5%a4%87%e4%bb%bd%e5%8c%85 aria-label=打备份包>打备份包</a></li><li><a href=#%e5%ae%89%e8%a3%85-%e9%98%bf%e9%87%8c%e4%ba%91-ossutils-%e5%b7%a5%e5%85%b7 aria-label="安装 阿里云 ossutils 工具">安装 阿里云 ossutils 工具</a></li><li><a href=#%e8%bf%98%e5%8e%9f%e5%a4%87%e4%bb%bd aria-label=还原备份>还原备份</a></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae aria-label=参考文献>参考文献</a></li></ul></div><div><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7296634171837358 data-ad-slot=9161921641 data-ad-format=auto data-full-width-responsive=true></ins></div><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></details></div><div class=post-content><blockquote style=margin-top:8px><p style=text-align:center;text-indent:0><a href=https://www.frytea.com/technology/others/310/>本文</a>
首发于
<a href=https://www.frytea.com/>🌱 煎茶</a>，
<a href=/disclaimer/>转载</a> 请注明
<a href=https://www.frytea.com/technology/others/310/>来源</a>。</p></blockquote><p>由于服务器到期等因素，需要对 GitLab 进行迁移，在此记下一段历程。</p><p>首先要保证迁入和迁出 GitLab 的版本是一致的，使用这一条指令：</p><pre><code>cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
</code></pre><p>我的两个服务器输出分别是：</p><pre><code># 迁入服务器
$ cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
12.7.5-ee
# 迁出服务器
$ cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
12.5.2-ee
</code></pre><h2 id=升级-gitlab>升级 GitLab<a hidden class=anchor aria-hidden=true href=#升级-gitlab>#</a></h2><p>因此需要对服务器进行升级。</p><p>我采用的安装方法是 <code>Omnibus</code>, 采用官网推荐的方式进行升级：</p><pre><code># Debian/Ubuntu
sudo apt-get update
sudo apt-get install gitlab-ce

# Centos/RHEL
sudo yum install gitlab-ce

# 如果是 ee就修改为 ee
</code></pre><p>其他升级方式可以来这里看：<a href=https://docs.gitlab.com/omnibus/update/README.html>Updating GitLab installed with the Omnibus GitLab package</a></p><h2 id=打备份包>打备份包<a hidden class=anchor aria-hidden=true href=#打备份包>#</a></h2><p>我采用的安装方法是 <code>Omnibus</code>, 采用官网推荐的方式进行打包：<a href=https://docs.gitlab.com/ee/raketasks/backup_restore.html#creating-a-backup-of-the-gitlab-system>Creating a backup of the GitLab system</a></p><pre><code>$ sudo gitlab-backup create
2020-02-06 10:23:21 +0000 -- Dumping database ...
Dumping PostgreSQL database gitlabhq_production ... [DONE]
2020-02-06 10:23:23 +0000 -- done
2020-02-06 10:23:23 +0000 -- Dumping repositories ...
 * songtianlun/journal (@hashed/6b/86/6b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4b) ... [SKIPPED]
[SKIPPED] Wiki
 * songtianlun/Frytea-Timeline (@hashed/d4/73/d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/haut-gis-org-github-io (@hashed/4e/07/4e07408562bedb8b60ce05c1decfe3ad16b72230967de01f640b7e4729b49fce) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/frytea-docs (@hashed/ef/2d/ef2d127de37b942baad06145e54b0c619a1f22327b2ebbcfbec78f5564afe39d) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/gatsby-starter-gine-blog (@hashed/e7/f6/e7f6c011776e8db7cd330b54174fd76f7d0216b612387a5ffcfb81e6f0919683) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/frytea-docs-ex (@hashed/79/02/7902699be42c8a8e46fbbb4501726517e86b22c56a189f7625a6da49081b2451) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Frytea-DataShare (@hashed/2c/62/2c624232cdd221771294dfbb310aca000a0df6ac8b66b696d90ef06fdefb64a3) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/markmap (@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Gis-SoDev-Expriment (@hashed/4a/44/4a44dc15364204a80fe80e9039455cc1608281820fe2b24f1e5233ade6af1dd5) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/jenkins-android-sample (@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Markdown-Syntax-CN (@hashed/6b/51/6b51d431df5d7f141cbececcf79edf3dd861c3b4069f0b11661a3eefacbba918) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/hexo-blog (@hashed/85/27/8527a891e224136950ff32ca212b45bc93f69fbb801c3b1ebedac52775f99e61) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Flash-Light (@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Image-Hosting (@hashed/45/23/4523540f1504cd17100c4835e85b7eefd49911580f8efff0599a8f283be6b9e3) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/vue_vue2leaflet (@hashed/4e/c9/4ec9599fc203d176a301536c2e091a19bc852759b255bd6818810a42c5fed14a) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/home-forward (@hashed/94/00/9400f1b21cb527d7fa3d3eabba93557a18ebe7a2ca4e471cfe5e4c5b4ca7f767) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/nodeppt (@hashed/f5/ca/f5ca38f748a1d6eaf726b8a42fb575c3c71f1864a8143301782de13da2d9202b) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/PathManager (@hashed/6f/4b/6f4b6612125fb3a0daecd2799dfd6c9c299424fd920f9b308110a2c1fbd8f443) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/perpetual-config (@hashed/78/5f/785f3ec7eb32f30b90cd0fcf3657d388b5ff4297f2f9716ff66e9b69c05ddd09) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/PathManager-Site (@hashed/53/5f/535fa30d7e25dd8a49f1536779734ec8286108d115da5045d77f3b4185d8f790) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/CuteOneP (@hashed/c2/35/c2356069e9d1e79ca924378153cfbbfb4d4416b1f99d41a2940bfdb66c5319db) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Education-manage-system (@hashed/b7/a5/b7a56873cd771f2c446d369b649430b65a756ba278ff97ec81bb6f55b2e73569) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/PL-indoor-RouteAnalyser (@hashed/5f/9c/5f9c4ab08cac7457e9111a30e4664920607ea2c115a1433d7be98e97e64244ca) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/ResumeSample (@hashed/67/06/670671cd97404156226e507973f2ab8330d3022ca96e0c93bdbdb320c41adcaf) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/programmer-url-navigation (@hashed/59/e1/59e19706d51d39f66711c2653cd7eb1291c94d9b55eb14bda74ce4dc636d015a) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/putianxi-github-io (@hashed/35/13/35135aaa6cc23891b40cb3f378c53a17a1127210ce60e125ccf03efcfdaec458) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/ci-matters (@hashed/62/4b/624b60c58c9d8bfb6ff1886c2fd605d2adeb6ea4da576068201b6c6958ce93f4) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/coding-interview-university (@hashed/eb/1e/eb1e33e8a81b697b75855af6bfcdbcbf7cbbde9f94962ceaec1ed8af21f5a50f) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/zhongguojinxiandaishishijianzhou (@hashed/e2/9c/e29c9c180c6279b0b02abd6a1801c7c04082cf486ec027aa13515e4f3884bb6b) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Web-Demo (@hashed/c6/f3/c6f3ac57944a531490cd39902d0f777715fd005efac9a30622d5f5205e7f6894) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/WebGis-SIC-Dev-Experiment (@hashed/86/e5/86e50149658661312a9e0b35558d84f6c6d3da797f552a9657fe0558ca40cdef) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/Small-Supermarket-manager-system (@hashed/9f/14/9f14025af0065b30e47e23ebb3b491d39ae8ed17d33739e5ff3827ffb3634953) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/sou (@hashed/76/a5/76a50887d8f1c2e9301755428990ad81479ee21c25b43215cf524541e0503269) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/songtianlun.pages.frytea.com (@hashed/7a/61/7a61b53701befdae0eeeffaecc73f14e20b537bb0f8b91ad7c2936dc63562b25) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/setup-node (@hashed/ae/a9/aea92132c4cbeb263e6ac2bf6c183b5d81737f179f21efdc5863739672f0f470) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/trajectory-community (@hashed/0b/91/0b918943df0962bc7a1824c0555a389347b4febdc7cf9d1254406d80ce44e3f9) ... [SKIPPED]
[SKIPPED] Wiki
 * songtianlun/gis-changchun-info-vue (@hashed/d5/9e/d59eced1ded07f84c145592f65bdf854358e009c5cd705f5215bf18697fed103) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/PlanAssistant (@hashed/3d/91/3d914f9348c9cc0ff8a79716700b9fcd4d2f3e711608004eb8f138bcba7f14d9) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/materialistic (@hashed/71/ee/71ee45a3c0db9a9865f7313dd3372cf60dca6479d46261f3542eb9346e4a04d6) ... [DONE]
[SKIPPED] Wiki
 * songtianlun/android-example (@hashed/81/17/811786ad1ae74adfdd20dd0372abaaebc6246e343aebd01da0bfc4c02bf0106c) ... [DONE]
[SKIPPED] Wiki
2020-02-06 10:23:46 +0000 -- done
2020-02-06 10:23:46 +0000 -- Dumping uploads ...
2020-02-06 10:23:47 +0000 -- done
2020-02-06 10:23:47 +0000 -- Dumping builds ...
2020-02-06 10:23:47 +0000 -- done
2020-02-06 10:23:47 +0000 -- Dumping artifacts ...
2020-02-06 10:23:50 +0000 -- done
2020-02-06 10:23:50 +0000 -- Dumping pages ...
2020-02-06 10:23:51 +0000 -- done
2020-02-06 10:23:51 +0000 -- Dumping lfs objects ...
2020-02-06 10:23:51 +0000 -- done
2020-02-06 10:23:51 +0000 -- Dumping container registry images ...
2020-02-06 10:23:51 +0000 -- [DISABLED]
Creating backup archive: 1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar ... done
Uploading backup archive to remote storage  ... skipped
Deleting tmp directories ... done
done
done
done
done
done
done
done
Deleting old backups ... skipping
Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data
and are not included in this backup. You will need these files to restore a backup.
Please back them up manually.
Backup task is done.
</code></pre><p>完成后就已经对 GitLab 整个系统备份到 <code>/var/opt/gitlab/backups</code>，根据官网除了打包还需要备份以下两个文件：</p><ul><li><code>/etc/gitlab/gitlab-secrets.json</code></li><li><code>/etc/gitlab/gitlab.rb</code></li></ul><p>因此将这个两个文件也拷入 <code>backups</code> 文件夹，以便后面打包迁移：</p><pre><code>cp /etc/gitlab/gitlab-secrets.json /var/opt/gitlab/backups/gitlab-secrets.json
cp /etc/gitlab/gitlab.rb /var/opt/gitlab/backups/gitlab.rb
</code></pre><p>完成后看一下 <code>/var/opt/gitlab/backups</code> 文件夹中就是我们需要迁移走的所有文件啦</p><pre><code>$ ls
1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar  gitlab.rb  gitlab-secrets.json
</code></pre><p>对它进行打包：</p><pre><code># 打包后，以 gzip 压缩
$ tar -zcvf /tmp/gitlab.2020.2.6.backups.tar.gz /var/opt/gitlab/backups
tar: Removing leading `/' from member names
/var/opt/gitlab/backups/
/var/opt/gitlab/backups/gitlab.rb
/var/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar
/var/opt/gitlab/backups/gitlab-secrets.json
</code></pre><h2 id=安装-阿里云-ossutils-工具>安装 阿里云 ossutils 工具<a hidden class=anchor aria-hidden=true href=#安装-阿里云-ossutils-工具>#</a></h2><p>在这里使用阿里云 oss 做中转，你也可使用其他方式将压缩包传入待转入服务器。</p><p>首先安装：</p><pre><code># 下载工具：
$ wget http://gosspublic.alicdn.com/ossutil/1.6.10/ossutil64                           

# 修改文件执行权限：
$ chmod 755 ossutil64

# 使用交互式配置生成配置文件：
$ ./ossutil64 config
请输入配置文件名，文件名可以带路径（默认为：/home/user/.ossutilconfig，回车将使用默认路径。如果用户设置为其它路径，在使用命令时需要将--config-file选项设置为该路径）：
未输入配置文件路径，将使用默认配置文件：/home/user/.ossutilconfig。
对于下述配置，回车将跳过相关配置项的设置，配置项的具体含义，请使用&quot;help config&quot;命令查看。
请输入endpoint：http://oss-cn-shenzhen.aliyuncs.com
请输入accessKeyID：yourAccessKeyID
请输入accessKeySecret：yourAccessKeySecret
请输入stsToken：
</code></pre><p>使用命令查看 endpoint,</p><pre><code>$ ./ossutil64 ls
CreationTime                                 Region    StorageClass    BucketName
2020-02-06 06:06:37 +0000 UTC        oss-cn-beijing        Standard    oss://frytea-temporary
2019-01-12 01:59:01 +0000 UTC        oss-cn-beijing        Standard    oss://mywebsites
2019-11-12 06:47:12 +0000 UTC       oss-cn-shenzhen        Standard    oss://onedrive-index
Bucket Number is: 3

0.298487(s) elapsed
</code></pre><p>上传</p><pre><code>$ ./ossutil64 cp /tmp/gitlab.2020.2.6.backups.tar.gz oss://frytea-temporary/gitlab/
Succeed: Total num: 1, size: 558,098,855. OK num: 1(upload 1 files).                                        

150.496710(s) elapsed
</code></pre><p>接下来来到待迁入服务器，同样执行 <code>安装</code> 之后进行下载：</p><pre><code>$ ./ossutil64 cp oss://frytea-temporary/gitlab/gitlab.2020.2.6.backups.tar.gz ~
Succeed: Total num: 1, size: 558,098,855. OK num: 1(download 1 objects).                                     

10.706132(s) elapsed
</code></pre><p>在这类迁入服务器是阿里云服务器，因此下载速度很快。</p><h2 id=还原备份>还原备份<a hidden class=anchor aria-hidden=true href=#还原备份>#</a></h2><p>首先将下载好的文件夹解压：</p><pre><code>$ tar -zxvf gitlab.2020.2.6.backups.tar.gz
var/opt/gitlab/backups/
var/opt/gitlab/backups/gitlab.rb
var/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar
var/opt/gitlab/backups/gitlab-secrets.json
</code></pre><p>压缩时保留了原有目录结构。</p><p>将备份文件拷入迁入服务器的 <code>/var/opt/gitlab/backups/</code> 文件夹：</p><pre><code>mv ~/var/opt/gitlab/backups/1580984631_2020_02_06_12.7.5-ee_gitlab_backup.tar /var/opt/gitlab/backups/
</code></pre><p>下面停止 GitLab 中于数据库交换数据的 服务：</p><pre><code>$ sudo gitlab-ctl stop unicorn
ok: down: unicorn: 3188s, normally up
$ sudo gitlab-ctl stop puma
$ sudo gitlab-ctl stop sidekiq
ok: down: sidekiq: 3186s, normally up
$ sudo gitlab-ctl status
run: alertmanager: (pid 23730) 4249s; run: log: (pid 23210) 4343s
run: gitaly: (pid 23585) 4252s; run: log: (pid 22585) 4451s
run: gitlab-exporter: (pid 23620) 4251s; run: log: (pid 23064) 4359s
run: gitlab-workhorse: (pid 23569) 4253s; run: log: (pid 22926) 4386s
run: grafana: (pid 23750) 4248s; run: log: (pid 23407) 4296s
run: logrotate: (pid 28170) 780s; run: log: (pid 22977) 4379s
run: nginx: (pid 23409) 4295s; run: log: (pid 22937) 4384s
run: node-exporter: (pid 23603) 4252s; run: log: (pid 23035) 4367s
run: postgres-exporter: (pid 23741) 4249s; run: log: (pid 23245) 4337s
run: postgresql: (pid 22682) 4446s; run: log: (pid 22731) 4443s
run: prometheus: (pid 23636) 4250s; run: log: (pid 23143) 4349s
run: redis: (pid 22520) 4458s; run: log: (pid 22535) 4457s
run: redis-exporter: (pid 23623) 4251s; run: log: (pid 23091) 4355s
run: registry: (pid 23578) 4252s; run: log: (pid 23018) 4371s
down: sidekiq: 3188s, normally up; run: log: (pid 22891) 4390s
down: unicorn: 3195s, normally up; run: log: (pid 22877) 4397s
</code></pre><p>恢复备份：</p><pre><code>$ sudo gitlab-backup restore BACKUP=1580984631_2020_02_06_12.7.5-ee
# 这里去掉备份名字的_gitlab_backup.tar
# 以下是输出
Transfering ownership of /var/opt/gitlab/gitlab-rails/shared/registry to git:git
Unpacking backup ... done
Before restoring the database, we will remove all existing
tables to avoid future upgrade problems. Be aware that if you have
custom tables in the GitLab database these tables and all data will be
removed.

Do you want to continue (yes/no)? yes
Removing all tables. Press `Ctrl-C` within 5 seconds to abort
2020-02-06 18:47:41 +0800 -- Cleaning the database ...
2020-02-06 18:47:42 +0800 -- done
2020-02-06 18:47:42 +0800 -- Restoring database ...
Restoring PostgreSQL database gitlabhq_production ... SET
...
rake aborted!
Errno::ENOENT: No such file or directory - /var/opt/gitlab/backups/registry.tar.gz
/opt/gitlab/embedded/service/gitlab-rails/lib/backup/files.rb:76:in `run_pipeline!'
/opt/gitlab/embedded/service/gitlab-rails/lib/backup/files.rb:44:in `restore'
/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/backup.rake:234:in `block (4 levels) in &lt;top (required)&gt;'
/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/backup.rake:71:in `block (3 levels) in &lt;top (required)&gt;'
/opt/gitlab/embedded/bin/bundle:23:in `load'
/opt/gitlab/embedded/bin/bundle:23:in `&lt;main&gt;'
Tasks: TOP =&gt; gitlab:backup:registry:restore
(See full trace by running task with --trace)
Transfering ownership of /var/opt/gitlab/gitlab-rails/shared/registry to registry:registry
</code></pre><p>将之前备份的另外两个文件迁入：</p><pre><code>mv /etc/gitlab/gitlab-secrets.json /etc/gitlab/gitlab-secrets.json.2020.2.6.backup
mv /etc/gitlab/gitlab.rb /etc/gitlab/gitlab.rb.2020.2.6.backup
mv ~/var/opt/gitlab/backups/gitlab-secrets.json /etc/gitlab/gitlab-secrets.json
mv ~/var/opt/gitlab/backups/gitlab.rb /etc/gitlab/gitlab.rb
</code></pre><p>重启 GitLab</p><pre><code>sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
sudo gitlab-rake gitlab:check SANITIZE=true
</code></pre><p>完成！</p><h2 id=参考文献>参考文献<a hidden class=anchor aria-hidden=true href=#参考文献>#</a></h2><ul><li><a href=https://blog.csdn.net/wo18237095579/article/details/81106150>如何查看 GitLab 版本号</a></li><li><a href=https://docs.gitlab.com/omnibus/update/README.html>Updating GitLab installed with the Omnibus GitLab package</a></li><li><a href=https://docs.gitlab.com/ee/raketasks/backup_restore.html#restore-for-omnibus-gitlab-installations>Backing up and restoring GitLab</a></li><li><a href=https://zhuanlan.zhihu.com/p/71958507>gitlab迁移</a></li><li><a href=https://www.cnblogs.com/cursorhu/p/5891699.html>Linux下的解压命令小结</a></li><li><a href=https://blog.csdn.net/shenyunsese/article/details/22798235>Linux tar打包命令</a></li><li><a href="https://help.aliyun.com/document_detail/120075.html?spm=a2c4g.11186623.6.698.4f072e69CcXU6K">对象存储 OSS > 常用工具 > 命令行工具ossutil > 下载和安装</a></li></ul><div class=post-meta></hr>注：本作品采用<a rel=license target=view_window href=http://creativecommons.org/licenses/by-nc-sa/4.0/> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议 </a>进行许可。</div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.frytea.com/tags/gitlab/>🏷 GitLab</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on twitter" href="https://twitter.com/intent/tweet/?text=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0&url=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f&hashtags=GitLab"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f&title=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0&summary=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0&source=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f&title=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on whatsapp" href="https://api.whatsapp.com/send?text=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0%20-%20https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 迁移 GitLab 小记 on telegram" href="https://telegram.me/share/url?text=%e8%bf%81%e7%a7%bb%20GitLab%20%e5%b0%8f%e8%ae%b0&url=https%3a%2f%2fwww.frytea.com%2ftechnology%2fothers%2f310%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><nav class=paginav><a class=prev href=https://www.frytea.com/technology/others/311/><span class=title>« 上一页</span><br><span>GitLab 神奇问题之ssl</span></a>
<a class=next href=https://www.frytea.com/technology/others/309/><span class=title>下一页 »</span><br><span>解决VMeare 安装 Android x86 错误</span></a></nav></footer><div id=vcomments style="background-color:var(--theme);margin-top:15px;padding:20px;border-radius:var(--radius);box-shadow:0 0 10px grey"></div><script type=text/javascript>new Valine({el:'#vcomments',appId:'mhm2sAPpC3cW2VJ15fpGGDPb-gzGzoHsz',appKey:'nx1gknfuCi4dsFHwG7cAbqUL',avatar:'retro',placeholder:'说点什么吧...',visitor:!0,recordIP:!0})</script></article></main><footer class=footer><span>Copyright &copy; 2022 • <a href=https://www.frytea.com/>Frytea</a></span>
<span>• <a href=http://beian.miit.gov.cn/ target=view_window>粤 ICP 备 19144283 号</a></span><div><span><a href=/about/>关于</a>
• <a href=/disclaimer/>免责声明</a>
• <a href=/sitemap.xml target=view_window>站点地图</a>
• <a href=https://www.foreverblog.cn/go.html target=view_window>虫洞</a>
• PV <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><meta name=”apple-mobile-web-app-capable” content="”yes”"><script>'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js')})</script></body></html>