name: Sync Projects to Main

on:
  push:
    branches: [ project ]
    paths: [ 'projects.json', 'scripts/generate-readme.js', '.github/workflows/sync-to-main.yml' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout project branch
      uses: actions/checkout@v4
      with:
        ref: project
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Generate README from projects.json
      run: make readme
        
    - name: Switch to main branch and update
      run: |
        git config user.name 'GitHub Action'
        git config user.email 'action@github.com'
        
        echo "Switching to main branch..."
        git checkout main
        
        echo "Copying generated README from project branch..."
        git show project:README.md > README_new.md
        
        echo "Checking if files differ..."
        if cmp -s README.md README_new.md 2>/dev/null; then
          echo "No changes detected"
          rm README_new.md
        else
          echo "Changes detected, updating README..."
          mv README_new.md README.md
          
          echo "Checking git status..."
          git status
          git diff --name-only
          
          if git diff --quiet HEAD; then
            echo "Git reports no changes after file replacement"
          else
            echo "Git confirms changes, committing..."
            git add README.md
            git commit -m "🤖 更新项目清单 自动生成于: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin main
            echo "✅ Updated successfully"
          fi
        fi