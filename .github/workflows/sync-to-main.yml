name: Sync Projects to Main

on:
  push:
    branches: [ project ]
    paths: [ 'projects.json', 'scripts/generate-readme.js', '.github/workflows/sync-to-main.yml' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout project branch
      uses: actions/checkout@v4
      with:
        ref: project
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Generate README from projects.json
      run: |
        make readme
        echo "Generated README file:"
        ls -la README.new.md
        head -5 README.new.md
        
    - name: Switch to main branch and update
      run: |
        git config user.name 'GitHub Action'
        git config user.email 'action@github.com'
        
        # Copy generated file to temp location before switching branches
        echo "Copying generated README to temp location..."
        cp README.new.md /tmp/README_generated.md
        
        echo "Switching to main branch..."
        git checkout main
        
        echo "Copying back the generated README..."
        cp /tmp/README_generated.md README_new.md
        
        echo "Checking files exist..."
        if [ ! -f README_new.md ] || [ ! -f README.md ]; then
          echo "README_new.md or README.md not found"
          ls -la README*
          exit 1
        fi
        
        echo "Comparing files..."
        if diff README.md README_new.md >/dev/null 2>&1; then
          echo "README.md and README_new.md are the same"
          rm README_new.md
        else
          echo "README.md and README_new.md are different, updating README.md"
          echo "First 5 lines of differences:"
          diff README.md README_new.md | head -5 || true
          
          mv README_new.md README.md
          
          echo "Checking git status after replacement..."
          git status
          
          if git diff --quiet HEAD; then
            echo "Git reports no changes - files are actually the same"
          else
            echo "Git confirms changes, committing..."
            git add README.md
            git commit -m "🤖 更新项目清单 自动生成于: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin main
            echo "✅ Updated successfully"
          fi
        fi
        
        # Cleanup
        rm -f /tmp/README_generated.md