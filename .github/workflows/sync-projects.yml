name: Sync Projects to Main Branch

on:
  push:
    branches: [ project ]
    paths: [ 'projects.json' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-projects:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Check current branch and files
      run: |
        echo "Current branch: $(git branch --show-current)"
        echo "Files in root:"
        ls -la
        echo "Checking for projects.json:"
        if [ -f "projects.json" ]; then
          echo "âœ… projects.json found"
        else
          echo "âŒ projects.json not found"
          exit 1
        fi
        
    - name: Generate README content
      run: |
        echo "ğŸ”„ Generating README content..."
        cat > generate-readme.js << 'SCRIPT_END'
        const fs = require('fs');
        try {
            const projectsData = JSON.parse(fs.readFileSync('projects.json', 'utf8'));
            const readmeContent = `ä¸ªäººä¸šä½™å¼€å‘é¡¹ç›®æ¸…å•

|                              åç§°                               | ç®€ä»‹                                         | é“¾æ¥                                                                                                                        | å¤‡æ³¨                     |
| :-----------------------------------------------------------: | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
${projectsData.map(project => {
    const name = project.name;
    const description = project.description || '';
    const year = project.year || '';
    const tags = project.tags ? project.tags.join('` `') : '';
    const links = [];
    if (project.links.github) {
        links.push(`[Git](${project.links.github})`);
    }
    if (project.links.main) {
        links.push(`[å…¥å£](${project.links.main})`);
    }
    if (project.links.docs) {
        links.push(`[Docs](${project.links.docs})`);
    }
    if (project.links.article) {
        links.push(`[ä»‹ç»æ–‡ç« ](${project.links.article})`);
    }
    const linkStr = links.join(' ');
    const tagStr = tags ? `\`SINCE ${year}\` \`${tags}\`` : `\`SINCE ${year}\``;
    return `| ${project.links.main ? `[${name}](${project.links.main})` : name} | ${description} | ${linkStr} | ${tagStr} |`;
}).join('\n')}

`;
            fs.writeFileSync('README_new.md', readmeContent);
            console.log('âœ… README generated successfully');
        } catch (error) {
            console.error('âŒ Error generating README:', error);
            process.exit(1);
        }
        SCRIPT_END
        node generate-readme.js
        
    - name: Switch to main branch and update README
      run: |
        echo "ğŸ”„ Switching to main branch..."
        git checkout main
        echo "ğŸ“ Copying new README..."
        cp README_new.md README.md
        rm README_new.md generate-readme.js
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        if git diff --quiet HEAD -- README.md; then
          echo "â„¹ï¸  No changes to README.md"
        else
          echo "ğŸš€ Updating README.md with latest project data"
          git add README.md
          git commit -m "ğŸ¤– è‡ªåŠ¨åŒæ­¥é¡¹ç›®æ¸…å•åˆ° README.md

ç”± GitHub Action è‡ªåŠ¨ç”Ÿæˆï¼ŒåŸºäº project åˆ†æ”¯çš„ projects.json æ–‡ä»¶

Generated at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin main
          echo "âœ… README.md updated successfully"
        fi