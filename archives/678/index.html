<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 | Frytea</title><meta name=keywords content><meta name=description content="OpenResty完全开发指南：构建百万级别并发的Web应用 罗剑锋 131个笔记 ◆ 第1章 总论 [插图] OpenResty使用四位数字作为版本号，"><meta name=author content="Tianlun Song"><link rel=canonical href=https://www.frytea.com/archives/678/><meta name=yandex-verification content="73b1a797f62c0e98"><meta name=baidu-site-verification content="code-gnOrbP1RyC"><meta name=baidu_union_verify content="4c552c344295cb984c46ebe74962b067"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKai-Light.css><link crossorigin=anonymous href=/assets/css/stylesheet.min.0a5d9aa21e56d0b7d41b1d4b56af0b911caf526faf5060a8d3717579bf27cb93.css integrity="sha256-Cl2aoh5W0LfUGx1LVq8LkRyvUm+vUGCo03F1eb8ny5M=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.frytea.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.frytea.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.frytea.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.frytea.com/apple-touch-icon.png><link rel=mask-icon href=https://www.frytea.com/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><link rel=manifest href=/manifest.json><script type=text/javascript>function downloadJSAtOnload(){var a=document.createElement("script");a.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7296634171837358",document.body.appendChild(a)}window.addEventListener?window.addEventListener("load",downloadJSAtOnload,!1):window.attachEvent?window.attachEvent("onload",downloadJSAtOnload):window.onload=downloadJSAtOnload</script><script async defer data-website-id=3d947a98-2774-46b0-805f-fe2e4877a1d7 src=https://umami.frytea.com/umami.js></script><script async src=https://www.frytea.com/js/busuanzi.pure.mini.js></script><link rel=stylesheet href=/libs/font-awesome-4.7.0/css/font-awesome.min.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script src=https://www.frytea.com/js/mermaid.min.js crossorigin=anonymous></script><script>const config={startOnLoad:!0,theme:'forest',themeVariables:{lineColor:"#fafafa"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(void 0,document.querySelectorAll('.language-mermaid'))}</script><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?c49e2f5be5e009382be07455c33b1394",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-136094326-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋"><meta property="og:description" content="OpenResty完全开发指南：构建百万级别并发的Web应用 罗剑锋 131个笔记 ◆ 第1章 总论 [插图] OpenResty使用四位数字作为版本号，"><meta property="og:type" content="article"><meta property="og:url" content="https://www.frytea.com/archives/678/"><meta property="og:image" content="https://www.frytea.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="archives"><meta property="article:published_time" content="2022-12-15T19:20:00+00:00"><meta property="article:modified_time" content="2022-12-15T19:20:00+00:00"><meta property="og:site_name" content="Frytea"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.frytea.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋"><meta name=twitter:description content="OpenResty完全开发指南：构建百万级别并发的Web应用 罗剑锋 131个笔记 ◆ 第1章 总论 [插图] OpenResty使用四位数字作为版本号，"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Archives","item":"https://www.frytea.com/archives/"},{"@type":"ListItem","position":2,"name":"[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋","item":"https://www.frytea.com/archives/678/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋","name":"[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋","description":"OpenResty完全开发指南：构建百万级别并发的Web应用 罗剑锋 131个笔记 ◆ 第1章 总论 [插图] OpenResty使用四位数字作为版本号，","keywords":[],"articleBody":"OpenResty完全开发指南：构建百万级别并发的Web应用 罗剑锋 131个笔记\n◆ 第1章 总论\n  [插图]\n    OpenResty使用四位数字作为版本号，形式是：a.b.c.x，其中前三位数字是内部Nginx的版本，作为大版本号，第四位数字是OpenResty自己的发布版本号，也就是小版本号\n    ​​/usr/local/openresty/ #安装主目录￼\u2028├── bin #存放可执行文件￼\u2028├── luajit #LuaJIT运行库￼\u2028├── lualib #Lua组件￼\u2028├── nginx #Nginx核心运行平台￼\u2028├── pod #参考手册（restydoc）使用的数据￼\u2028└── site #包管理工具（opm）使用的数据​​\n    利用UNIX的“Shebang”(#! )，在脚本文件里的第一行指定resty作为解释器\n    [插图]\n  ◆ 第2章 Nginx平台\n  Nginx是一个高性能、高稳定的轻量级HTTP、TCP、UDP和反向代理服务器\n    配置HTTP相关的功能需要使用指令http{}，定义OpenResty里对外提供的HTTP服务，通常的形式是： ​​http { #http块开始，所有的HTTP相关功能\u2028server { #server块，第一个Web服务\u2028listen 80; #监听80端口\u2028location uri { #location块，需指定URI\u2028… #定义访问此URI时的具体行为\u2028} #location块结束\u2028} #server块结束\u2028server { #server块，第二个Web服务\u2028listen xxx; #监听xxx端口\u2028… #其他location定义\u2028} #server块结束\u2028} #http块结束​​ 由于http块内容太多，如果都写在一个文件里可能会造成配置文件过度庞大，难以维护。\n    反向代理（Reverse Proxy）是现今网络中一种非常重要的技术，它位于客户端和真正的服务器（即所谓的后端）之间，接受客户端的请求并转发给后端，然后把后端的处理结果返回给客户端\n  ◆ 第3章 Lua语言\n  Sol”这个词在葡萄牙语（巴西官方语言）里是太阳的意思，而“Lua”的意思就是月亮。\n    知名的应用有Adobe Lightroom、Fire-fox、Redis等，而游戏则有《魔兽世界》《愤怒的小鸟》《我的世界》等。\n    Lua语言提供六种基本的数据类型\n    Lua的字符串形式非常灵活，单引号或者双引号都可以，字符串里也允许使用转义符\n    Lua还用“[[…]]”的形式支持raw string，括号内的字符不会转义，在写正则表达式或者字符串里有引号、斜线的时候非常方便\n    与多行注释类似，“[[…]]”的形式也支持在括号中间插入“=”，而且如果“[[”后面是一个换行，那么Lua会自动忽略这个换行，在书写大量文字时是个非常方便的特性\n    Lua字符串的另外一个特点是只读的\n    Lua语言在内部使用一个全局散列表来管理所有的字符串，所以多个相同的字符串不会占用多份内存\n    Lua语言里的变量有作用域的概念，分为局部变量和全局变量，名字区分大小写\n    局部变量需要使用关键字“local”声明，作用域仅限本代码块（文件内或语句块内），没有关键字“local”声明的变量都是全局变量，而且不需要声明就可以直接使用\n    在Lua里应当尽量少使用全局变量，多使用局部变量\n    因为“局部化”，解释器查找的速度也更快\n    一个比较常用的全局变量是：“_”（下画线，也是合法的变量名）\n    Lua语言里没有“常量”，实践中我们通常用全大写名字的变量来表示常量\n    Lua里的运算有算术运算、关系运算、逻辑运算、字符串运算等\n    不等比较使用的是“~=”\n    在执行大于或小于比较操作时Lua会检查变量的类型，如果类型不同就会出错\n    但“==”和“~=”的行为则不同，如果类型不同会直接返回false\n    为了避免发生意外，必须用函数tonumber()/tostring()显式转换数字或字符串后再做比较运算\n    Lua的逻辑运算符有and、or和not三个\n    nil和false认为是假，其他都是真，包括数字0\n    x and y，如果x是真，返回y，否则返回x\n    x or y，与and操作正好相反，如果x是真，返回x，否则返回y\n    not x，只返回true/false，对x取反\n    Lua对字符串连接操作提供了一个特别的运算符“..”\n    连接运算还可以自动把数字转换为字符串，无须显式调用tostring()函数：\n    字符串连接操作应当尽量少用，因为每一次字符串连接就会创建一个新的字符串对象\n    如果多次操作超长字符串（例如几十MB的大块数据）就可能会导致LuaVM内存耗尽，发生错误。\n    计算字符串的长度可以用另一个特别的运算符“#”\n    字符串的关系运算基于字符序（例如最常用的ASCII码表）逐个检查，但相等比较是直接计算内部保存的散列值\n    很多时候对nil运算都会导致错误\n    如果一个变量可能是nil，最好使用or运算给它一个默认值\n    Lua里的语句包括赋值语句、分支语句和循环语句\n    Lua语句的格式非常自由，不强制要求缩进。语句末尾可以使用“;”表示结束，但不是必需的\n    使用“do…end”的形式就声明了一个语句（代码）块\n    Lua使用“=”在变量里存储一个确定类型的值\n    Lua还允许用逗号分隔，在一个语句里声明或赋值多个变量\n    如果给一个变量赋值为nil，就表示删除了这个变量\n    Lua的分支语句只有一种，就是if-else\n    多重分支需要使用“elseif”\n    Lua语言的循环语句有while、repeat-until和for三种\n    repeat-until循环与while差不多，但条件判断与while意义是相反的\n    Lua的for循环语句有两种形式：数值循环和范围循环\n    for的数值循环类似其他语言的标准for语句，但形式上要简洁一些\n    变量var从m前进（或后退）到n，执行循环体里的语句，参数step是用于控制var前进或后退的步长，可以省略，默认是1\n    for循环里的变量var会自动声明为局部变量\n    可以用break或者return直接跳出循环，用法与其他语言相同，但必须在语句块的最后——也就是后面紧跟着end/until关键字\n    如果想要在任意的位置结束循环，可以使用“do break end”的形式\n    OpenResty使用的LuaJIT扩展支持goto，可以变通实现continue\n    在Lua语言里函数是一类特殊的变量，它持有一个语句块，能够使用参数执行语句块（也就是“调用”），然后返回结果\n    Lua的函数就是变量，也可以（最好）使用local局部化。\n    可以传入任意数量的实参，少的默认值是nil，多的则被忽略\n    函数的返回值使用return语句，可以用逗号分隔返回多个值，但如果被调用时使用圆括号包围则只会返回一个值\n    Lua函数的参数都是传值（但表除外）\n    如果调用时只有一个传入的参数，而且这个参数是字符串或者表，那么Lua允许省略函数的“()”，直接在函数名后写参数\n    但Lua的表更加灵活，能够模拟出array、list、dict、set、map等常见数据结构，或者其他任意复杂的结构\n    Lua表里作为索引的key可以是任何非nil值，所以当key类型是整数时表就相当于数组，key类型是字符串时表就相当于字典或关联数组\n    Lua表对value的类型没有任何限制，当然也可以是另外一个表，从而实现多个表的嵌套。\n    Lua里定义表使用花括号“{}”\n    直接使用“{}”就是一个空表，在里面简单地列出表内的元素就声明了一个数组形式的表，使用“key=value”的形式就可以声明为字典形式的表\n    使用“key=value”的形式时key不需要用单引号或双引号，如果必须要用（例如key里有空格或者其他特殊符号）则要使用“[key]=value”的形式\n    定义表时的逗号“,”也可以改用分号“;”，两者没有不同，但可以做一些形式上的区分\n    Lua的表是动态的数据结构，不仅可以访问已有的元素，也可以随时向表里添加或删除元素\n    操作表里的元素需要使用方括号“[]”\n    当表作为数组来使用时整数下标索引必须从1开始计数\n    如果key是字符串我们也可以直接使用点号“.”来操作\n    运算符“#”可以计算形式表里的数组元素数量，配合for循环可以实现遍历数组\n    对于字典形式的表，暂时没有办法能够直接获取元素的数量，使用“#”会返回0\n    for循环语句的第二种形式——范围循环主要用于遍历表里的元素，但需要两个标准库函数的配合：ipairs()和pairs()。\n    模块就是一个函数集合，通常表现为一个Lua表，里面有模块作者提供的各种功能函数，使用点号“.”即可访问\n    使用require函数可以加载模块，参数是模块所在的文件名（省略后缀）\n    通常我们需要用变量来保存require函数的返回结果\n    require在加载模块的同时会执行文件里的代码\n    如果使用字符串作为key，那么表本身就是对象，可以任意存储变量和函数\n    封装”方面，Lua不提供private、public这样的修饰词，表里的所有成员都是公开的\n    如果想要实现私有成员，那么可以在模块文件里用local修饰\n    “多态”特性对于Lua来说非常简单，由于表是动态的，里面的成员都能够在运行时随意替换，没有编译型语言静态绑定的烦恼。\n    继承”在Lua语言里是不提倡的特性，替代方案是使用“原型”（prototype）模式，从一个“原型”对象“克隆”出一个新对象，然后再动态变更其属性，从而达到与“继承”类似的效果。\n    “原型”模式需要使用Lua的高级特性“元表”（metatable）和函数setmetatable()。\n    元表描述了表的基本行为，有些类似C++或者Python里的操作符重载，我们需要用的是“__index”元方法，它重载了Lua里查找key的操作，也就是table.key。\n    函数setmetatable(t, meta)把表t的元表设置为meta并返回t。\n    如果meta里设置了“__index”方法，那么对t的操作t.key也会同样作用到meta上，即meta.key。这样，表t就“克隆”了表meta的所有成员，表meta就成为了表t的“原型”。 可以通过下面的例子来进一步理解Lua的“原型”操作： ​​local proto = {} – 首先声明一个原型对象，暂时是空表\u2028function proto.go() – 为表添加一个方法，即成员函数\u2028print(“go pikachu”)\u2028end\u2028local mt = { __index = proto } – 定义元表，注意重载了“__index”\u2028local obj = setmetatable({}, mt) – 调用setmetatable设置元表，返回新表\u2028obj.go() – 新对象是原型的“克隆”，可以执行原型的操作​​ 代码里的关键操作是定义元表mt，里面只需要设置“__index”方法，然后再使用函数setmetatable从mt克隆出一个新的对象。 这两个步骤也可以合并为一次操作：\n    Lua为面向对象的方式使用表内成员函数提供一个特殊的操作符“:”，它的功能与“.”基本相同，但在调用函数时会隐含传入一个“self”参数\n    “:”和self不仅可以用在函数调用时，也可以用在函数定义时\n    “:”其实是一种“语法糖”，是简化的“.”写法\n    建议尽量使用“:”，它更简洁一些\n    应该用OpenResty自己的ngx.re系列函数\n    过table.insert的效率并不高，我们可以用如下的方式更高效地在末尾添加元素：\n    a[#a + 1] = ‘nginx’ – 利用“#”运算符获取长度来添加元素​​\n    io库里是操作文件的函数，由于文件通常存储在磁盘上，而且是阻塞操作，速度很慢，在OpenResty里应当尽量少用。\n    在读取数据时，可以使用参数“*a”（即all）读取整个文件，或者“*l”（即line）读取一行，使用数字则读取指定长度的字节\n    os库包含有操作系统和时间日期相关的函数\n    形象（但不很准确）地来说，“闭包”就是一个“活的函数”，存在于程序的“高维空间”，可以任意操作函数外部的数据\n    如果想要Lua代码更加健壮，我们可以使用保护模式来执行可能出错的函数\n    pcall（protected call）是base库里的一个特殊函数，它“保护调用”一个函数，绝对不会出错，并以true/false返回调用结果\n  ◆ 第4章 LuaJIT环境\n  LuaJIT是Lua语言的另一个实现，包括一个汇编语言编写的解释器和一个JIT编译器\n    使用“::label::”的形式定义标签，之后就可以随时用goto改变程序的流程\n    LuaJIT增强了table库，为它添加了一些新函数，其中较有用的有table.new、table.clear和table.clone。\n    函数table.clear把表置为空表，但保留之前分配的内存\n    函数table.clone是OpenResty的LuaJIT分支独有特性，可以高效地“浅”拷贝表（shallow clone）\n    ffi库不仅可以调用系统函数和OpenResty内部的C函数，还可以加载so形式的动态库，调用动态库里的函数\n    LuaJIT总是先用解释器运行编译后的字节码，并在运行时做“热点分析”，如果某段代码足够“热”，就会自动触发JIT编译器，尝试把字节码再编译成本地的机器码，让程序能够以最快的速度运行。\n    有的Lua函数因为实现的代价较高所以不会被编译，只能以字节码的形式运行，这些被称为NYI（Not Yet Implemented）。\n  ◆ 第5章 开发概述\n  OpenResty提供一个专用指令“content_by_lua_block”，可以在配置文件里书写Lua代码，产生响应内容\n    启动应用需要使用“-c”参数，让OpenResty以指定的配置文件运行：/usr/local/openresty/bin/openresty -c “pwd/hello.conf”\n    5.1节的例子是最简单的OpenResty应用，只有一个配置文件，应用代码写在了配置文件里。但实际的项目要比它复杂很多，配置文件和应用代码最好分离管理维护，此外还会有其他的监控脚本、日志文件、数据文件等，必须要用很好的目录层次把它们组织起来。 通常一个OpenResty应用的目录结构如下：[插图] ​​path/to/application #应用的主目录\u2028├── bin #脚本目录，存放各种脚本文件\u2028├── conf #配置目录，存放Nginx配置文件\u2028│ ├── http #存放HTTP服务的配置文件\u2028│ ├── stream #存放TCP/UDP服务的配置文件\n    在OpenResty里ngx_lua和stream_lua分别属于两个不同的子系统，但指令的功能和格式基本相同\n    OpenResty目前关注的是initing和running这两个阶段，并做了更细致的划分。\n    开发者必须较好地理解这些阶段的含义和作用，再结合自己的实际业务需求，选择恰当的阶段编写代码实现功能\n    OpenResty使用“定时器”来周期性地（一次或多次）执行“后台任务”。\n    这些接口大部分位于全局表ngx里，无须require即可访问（不过也有部分例外）\n    与Lua自带的标准库函数不同，它们基于Nginx的事件机制和Lua的协程特性，都是“100% nonblocking”的，能够让我们轻松编写出同步非阻塞的高效代码\n    OpenResty自带了很多Lua库（位于安装目录的lualib内）, lua-resty-core是其中最重要的一个，它使用ffi重新实现了OpenResty里原有的大多数函数，并增加了一些新的功能。\n  ◆ 第6章 基础功能\n  ngx.sleep是OpenResty提供的同步非阻塞的睡眠函数，可以“睡眠”任意的时间长度但不会阻塞整个服务，这时OpenResty会基于协程机制转而处理其他的请求，等睡眠时间到再“回头”继续执行ngx.sleep后续的代码。\n    MessagePack是一种二进制数据编码格式，与JSON相比更加小巧紧凑，适合序列化传输大批量的数据。\n    OpenResty在表ngx.re里提供六个正则表达式相关函数，它们的底层实现是PCRE库，速度极快，完全可以代替Lua标准库的字符串匹配函数\n    正则替换也有两个函数：ngx.re.sub和ngx.re.gsub，我们在使用时最好不要加“o”选项（原因见6.5.2节\n    ngx.re.gsub是ngx.re.sub的增强版，可以执行多次正则替换\n    Cache的容量通常都是有限的，需要使用某种算法更新淘汰数据，较常见的有FIFO、LFU、LRU等\n    OpenResty基于LRU算法提供了一个方便易用的Cache库lua-resty-lru-cache，并且支持过期时间功能（expire）\n    cache对象的功能接口十分简单易用，提供基本的set/get/delete等操作，用起来就像是一个Key-Value的散列表，缓存内的元素也可以是任何Lua数据（数字、字符串、函数、表等），无须序列化或反序列化\n  ◆ 第7章 HTTP服务\n  状态码表示HTTP请求的处理状态，目前RFC规范里有一百多个，在OpenResty里只定义了少量最常见的，\n  ◆ 第8章 访问后端\n  必须利用Redis、MySQL等数据库服务存储缓存、会话和其他数据，利用Kafka、RabbitMQ等消息队列服务异步发送消息，以及访问Tomcat、PHP等业务服务，访问ZooKeeper、Consul等配置服务，综合协调这些后端才能为最终用户呈现出一个功能完备的应用服务。\n  ","wordCount":"6769","inLanguage":"zh","datePublished":"2022-12-15T19:20:00Z","dateModified":"2022-12-15T19:20:00Z","author":{"@type":"Person","name":"Tianlun Song"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.frytea.com/archives/678/"},"publisher":{"@type":"Organization","name":"Frytea","logo":{"@type":"ImageObject","url":"https://www.frytea.com/favicon.ico"}}}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.frytea.com/ accesskey=h title="🏡 Frytea (Alt + H)">🏡 Frytea</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.frytea.com/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=https://www.frytea.com/search/ title="🔍 索引 (Alt + /)" accesskey=/><span>🔍 索引</span></a></li><li><a href=https://www.frytea.com/friends title="🧑‍🤝‍🧑 友链"><span>🧑‍🤝‍🧑 友链</span></a></li><li><a href=https://www.travellings.cn/go.html title=🚇><span>🚇</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.frytea.com/>主页</a>&nbsp;»&nbsp;<a href=https://www.frytea.com/archives/>Archives</a></div><h1 class=post-title><a href=https://www.frytea.com/archives/678/>[摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋</a></h1><div class=post-meta>December 15, 2022&nbsp;·&nbsp;14 分钟&nbsp;·&nbsp;6769 字&nbsp;·&nbsp;Tianlun Song&nbsp;|&nbsp;<a href=https://github.com/songtianlun/songtianlun.github.io/edit/main/content/archives/[%e6%91%98%e5%bd%95]%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b---%e7%bd%97%e5%89%91%e9%94%8b.md rel="noopener noreferrer" target=_blank>PR</a>
<span>| <span class=waline-pageview-count data-path=/archives/678/><i class="fa fa-spinner fa-spin"></i></span> Hits</span></div></header><div class=post-content><blockquote style=margin-top:8px><p style=text-align:center;text-indent:0><a href=https://www.frytea.com/archives/678/>本文</a>
首发于
<a href=https://www.frytea.com/>🌱 煎茶</a>，
<a href=/disclaimer/>转载</a> 请注明
<a href=https://www.frytea.com/archives/678/>来源</a>。</p></blockquote><p>OpenResty完全开发指南：构建百万级别并发的Web应用
罗剑锋
131个笔记</p><p>◆ 第1章 总论</p><blockquote><blockquote><p>[插图]</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty使用四位数字作为版本号，形式是：a.b.c.x，其中前三位数字是内部Nginx的版本，作为大版本号，第四位数字是OpenResty自己的发布版本号，也就是小版本号</p></blockquote></blockquote><blockquote><blockquote><p>​​/usr/local/openresty/ #安装主目录￼ ├── bin #存放可执行文件￼ ├── luajit #LuaJIT运行库￼ ├── lualib #Lua组件￼ ├── nginx #Nginx核心运行平台￼ ├── pod #参考手册（restydoc）使用的数据￼ └── site #包管理工具（opm）使用的数据​​</p></blockquote></blockquote><blockquote><blockquote><p>利用UNIX的“Shebang”(#! )，在脚本文件里的第一行指定resty作为解释器</p></blockquote></blockquote><blockquote><blockquote><p>[插图]</p></blockquote></blockquote><p>◆ 第2章 Nginx平台</p><blockquote><blockquote><p>Nginx是一个高性能、高稳定的轻量级HTTP、TCP、UDP和反向代理服务器</p></blockquote></blockquote><blockquote><blockquote><p>配置HTTP相关的功能需要使用指令http{}，定义OpenResty里对外提供的HTTP服务，通常的形式是：
​​http { #http块开始，所有的HTTP相关功能  server { #server块，第一个Web服务  listen 80; #监听80端口  location uri { #location块，需指定URI  &mldr; #定义访问此URI时的具体行为  } #location块结束  } #server块结束  server { #server块，第二个Web服务  listen xxx; #监听xxx端口  &mldr; #其他location定义  } #server块结束 } #http块结束​​
由于http块内容太多，如果都写在一个文件里可能会造成配置文件过度庞大，难以维护。</p></blockquote></blockquote><blockquote><blockquote><p>反向代理（Reverse Proxy）是现今网络中一种非常重要的技术，它位于客户端和真正的服务器（即所谓的后端）之间，接受客户端的请求并转发给后端，然后把后端的处理结果返回给客户端</p></blockquote></blockquote><p>◆ 第3章 Lua语言</p><blockquote><blockquote><p>Sol”这个词在葡萄牙语（巴西官方语言）里是太阳的意思，而“Lua”的意思就是月亮。</p></blockquote></blockquote><blockquote><blockquote><p>知名的应用有Adobe Lightroom、Fire-fox、Redis等，而游戏则有《魔兽世界》《愤怒的小鸟》《我的世界》等。</p></blockquote></blockquote><blockquote><blockquote><p>Lua语言提供六种基本的数据类型</p></blockquote></blockquote><blockquote><blockquote><p>Lua的字符串形式非常灵活，单引号或者双引号都可以，字符串里也允许使用转义符</p></blockquote></blockquote><blockquote><blockquote><p>Lua还用“[[&mldr;]]”的形式支持raw string，括号内的字符不会转义，在写正则表达式或者字符串里有引号、斜线的时候非常方便</p></blockquote></blockquote><blockquote><blockquote><p>与多行注释类似，“[[&mldr;]]”的形式也支持在括号中间插入“=”，而且如果“[[”后面是一个换行，那么Lua会自动忽略这个换行，在书写大量文字时是个非常方便的特性</p></blockquote></blockquote><blockquote><blockquote><p>Lua字符串的另外一个特点是只读的</p></blockquote></blockquote><blockquote><blockquote><p>Lua语言在内部使用一个全局散列表来管理所有的字符串，所以多个相同的字符串不会占用多份内存</p></blockquote></blockquote><blockquote><blockquote><p>Lua语言里的变量有作用域的概念，分为局部变量和全局变量，名字区分大小写</p></blockquote></blockquote><blockquote><blockquote><p>局部变量需要使用关键字“local”声明，作用域仅限本代码块（文件内或语句块内），没有关键字“local”声明的变量都是全局变量，而且不需要声明就可以直接使用</p></blockquote></blockquote><blockquote><blockquote><p>在Lua里应当尽量少使用全局变量，多使用局部变量</p></blockquote></blockquote><blockquote><blockquote><p>因为“局部化”，解释器查找的速度也更快</p></blockquote></blockquote><blockquote><blockquote><p>一个比较常用的全局变量是：“_”（下画线，也是合法的变量名）</p></blockquote></blockquote><blockquote><blockquote><p>Lua语言里没有“常量”，实践中我们通常用全大写名字的变量来表示常量</p></blockquote></blockquote><blockquote><blockquote><p>Lua里的运算有算术运算、关系运算、逻辑运算、字符串运算等</p></blockquote></blockquote><blockquote><blockquote><p>不等比较使用的是“~=”</p></blockquote></blockquote><blockquote><blockquote><p>在执行大于或小于比较操作时Lua会检查变量的类型，如果类型不同就会出错</p></blockquote></blockquote><blockquote><blockquote><p>但“==”和“~=”的行为则不同，如果类型不同会直接返回false</p></blockquote></blockquote><blockquote><blockquote><p>为了避免发生意外，必须用函数tonumber()/tostring()显式转换数字或字符串后再做比较运算</p></blockquote></blockquote><blockquote><blockquote><p>Lua的逻辑运算符有and、or和not三个</p></blockquote></blockquote><blockquote><blockquote><p>nil和false认为是假，其他都是真，包括数字0</p></blockquote></blockquote><blockquote><blockquote><p>x and y，如果x是真，返回y，否则返回x</p></blockquote></blockquote><blockquote><blockquote><p>x or y，与and操作正好相反，如果x是真，返回x，否则返回y</p></blockquote></blockquote><blockquote><blockquote><p>not x，只返回true/false，对x取反</p></blockquote></blockquote><blockquote><blockquote><p>Lua对字符串连接操作提供了一个特别的运算符“..”</p></blockquote></blockquote><blockquote><blockquote><p>连接运算还可以自动把数字转换为字符串，无须显式调用tostring()函数：</p></blockquote></blockquote><blockquote><blockquote><p>字符串连接操作应当尽量少用，因为每一次字符串连接就会创建一个新的字符串对象</p></blockquote></blockquote><blockquote><blockquote><p>如果多次操作超长字符串（例如几十MB的大块数据）就可能会导致LuaVM内存耗尽，发生错误。</p></blockquote></blockquote><blockquote><blockquote><p>计算字符串的长度可以用另一个特别的运算符“#”</p></blockquote></blockquote><blockquote><blockquote><p>字符串的关系运算基于字符序（例如最常用的ASCII码表）逐个检查，但相等比较是直接计算内部保存的散列值</p></blockquote></blockquote><blockquote><blockquote><p>很多时候对nil运算都会导致错误</p></blockquote></blockquote><blockquote><blockquote><p>如果一个变量可能是nil，最好使用or运算给它一个默认值</p></blockquote></blockquote><blockquote><blockquote><p>Lua里的语句包括赋值语句、分支语句和循环语句</p></blockquote></blockquote><blockquote><blockquote><p>Lua语句的格式非常自由，不强制要求缩进。语句末尾可以使用“;”表示结束，但不是必需的</p></blockquote></blockquote><blockquote><blockquote><p>使用“do&mldr;end”的形式就声明了一个语句（代码）块</p></blockquote></blockquote><blockquote><blockquote><p>Lua使用“=”在变量里存储一个确定类型的值</p></blockquote></blockquote><blockquote><blockquote><p>Lua还允许用逗号分隔，在一个语句里声明或赋值多个变量</p></blockquote></blockquote><blockquote><blockquote><p>如果给一个变量赋值为nil，就表示删除了这个变量</p></blockquote></blockquote><blockquote><blockquote><p>Lua的分支语句只有一种，就是if-else</p></blockquote></blockquote><blockquote><blockquote><p>多重分支需要使用“elseif”</p></blockquote></blockquote><blockquote><blockquote><p>Lua语言的循环语句有while、repeat-until和for三种</p></blockquote></blockquote><blockquote><blockquote><p>repeat-until循环与while差不多，但条件判断与while意义是相反的</p></blockquote></blockquote><blockquote><blockquote><p>Lua的for循环语句有两种形式：数值循环和范围循环</p></blockquote></blockquote><blockquote><blockquote><p>for的数值循环类似其他语言的标准for语句，但形式上要简洁一些</p></blockquote></blockquote><blockquote><blockquote><p>变量var从m前进（或后退）到n，执行循环体里的语句，参数step是用于控制var前进或后退的步长，可以省略，默认是1</p></blockquote></blockquote><blockquote><blockquote><p>for循环里的变量var会自动声明为局部变量</p></blockquote></blockquote><blockquote><blockquote><p>可以用break或者return直接跳出循环，用法与其他语言相同，但必须在语句块的最后——也就是后面紧跟着end/until关键字</p></blockquote></blockquote><blockquote><blockquote><p>如果想要在任意的位置结束循环，可以使用“do break end”的形式</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty使用的LuaJIT扩展支持goto，可以变通实现continue</p></blockquote></blockquote><blockquote><blockquote><p>在Lua语言里函数是一类特殊的变量，它持有一个语句块，能够使用参数执行语句块（也就是“调用”），然后返回结果</p></blockquote></blockquote><blockquote><blockquote><p>Lua的函数就是变量，也可以（最好）使用local局部化。</p></blockquote></blockquote><blockquote><blockquote><p>可以传入任意数量的实参，少的默认值是nil，多的则被忽略</p></blockquote></blockquote><blockquote><blockquote><p>函数的返回值使用return语句，可以用逗号分隔返回多个值，但如果被调用时使用圆括号包围则只会返回一个值</p></blockquote></blockquote><blockquote><blockquote><p>Lua函数的参数都是传值（但表除外）</p></blockquote></blockquote><blockquote><blockquote><p>如果调用时只有一个传入的参数，而且这个参数是字符串或者表，那么Lua允许省略函数的“()”，直接在函数名后写参数</p></blockquote></blockquote><blockquote><blockquote><p>但Lua的表更加灵活，能够模拟出array、list、dict、set、map等常见数据结构，或者其他任意复杂的结构</p></blockquote></blockquote><blockquote><blockquote><p>Lua表里作为索引的key可以是任何非nil值，所以当key类型是整数时表就相当于数组，key类型是字符串时表就相当于字典或关联数组</p></blockquote></blockquote><blockquote><blockquote><p>Lua表对value的类型没有任何限制，当然也可以是另外一个表，从而实现多个表的嵌套。</p></blockquote></blockquote><blockquote><blockquote><p>Lua里定义表使用花括号“{}”</p></blockquote></blockquote><blockquote><blockquote><p>直接使用“{}”就是一个空表，在里面简单地列出表内的元素就声明了一个数组形式的表，使用“key=value”的形式就可以声明为字典形式的表</p></blockquote></blockquote><blockquote><blockquote><p>使用“key=value”的形式时key不需要用单引号或双引号，如果必须要用（例如key里有空格或者其他特殊符号）则要使用“[key]=value”的形式</p></blockquote></blockquote><blockquote><blockquote><p>定义表时的逗号“,”也可以改用分号“;”，两者没有不同，但可以做一些形式上的区分</p></blockquote></blockquote><blockquote><blockquote><p>Lua的表是动态的数据结构，不仅可以访问已有的元素，也可以随时向表里添加或删除元素</p></blockquote></blockquote><blockquote><blockquote><p>操作表里的元素需要使用方括号“[]”</p></blockquote></blockquote><blockquote><blockquote><p>当表作为数组来使用时整数下标索引必须从1开始计数</p></blockquote></blockquote><blockquote><blockquote><p>如果key是字符串我们也可以直接使用点号“.”来操作</p></blockquote></blockquote><blockquote><blockquote><p>运算符“#”可以计算形式表里的数组元素数量，配合for循环可以实现遍历数组</p></blockquote></blockquote><blockquote><blockquote><p>对于字典形式的表，暂时没有办法能够直接获取元素的数量，使用“#”会返回0</p></blockquote></blockquote><blockquote><blockquote><p>for循环语句的第二种形式——范围循环主要用于遍历表里的元素，但需要两个标准库函数的配合：ipairs()和pairs()。</p></blockquote></blockquote><blockquote><blockquote><p>模块就是一个函数集合，通常表现为一个Lua表，里面有模块作者提供的各种功能函数，使用点号“.”即可访问</p></blockquote></blockquote><blockquote><blockquote><p>使用require函数可以加载模块，参数是模块所在的文件名（省略后缀）</p></blockquote></blockquote><blockquote><blockquote><p>通常我们需要用变量来保存require函数的返回结果</p></blockquote></blockquote><blockquote><blockquote><p>require在加载模块的同时会执行文件里的代码</p></blockquote></blockquote><blockquote><blockquote><p>如果使用字符串作为key，那么表本身就是对象，可以任意存储变量和函数</p></blockquote></blockquote><blockquote><blockquote><p>封装”方面，Lua不提供private、public这样的修饰词，表里的所有成员都是公开的</p></blockquote></blockquote><blockquote><blockquote><p>如果想要实现私有成员，那么可以在模块文件里用local修饰</p></blockquote></blockquote><blockquote><blockquote><p>“多态”特性对于Lua来说非常简单，由于表是动态的，里面的成员都能够在运行时随意替换，没有编译型语言静态绑定的烦恼。</p></blockquote></blockquote><blockquote><blockquote><p>继承”在Lua语言里是不提倡的特性，替代方案是使用“原型”（prototype）模式，从一个“原型”对象“克隆”出一个新对象，然后再动态变更其属性，从而达到与“继承”类似的效果。</p></blockquote></blockquote><blockquote><blockquote><p>“原型”模式需要使用Lua的高级特性“元表”（metatable）和函数setmetatable()。</p></blockquote></blockquote><blockquote><blockquote><p>元表描述了表的基本行为，有些类似C++或者Python里的操作符重载，我们需要用的是“__index”元方法，它重载了Lua里查找key的操作，也就是table.key。</p></blockquote></blockquote><blockquote><blockquote><p>函数setmetatable(t, meta)把表t的元表设置为meta并返回t。</p></blockquote></blockquote><blockquote><blockquote><p>如果meta里设置了“__index”方法，那么对t的操作t.key也会同样作用到meta上，即meta.key。这样，表t就“克隆”了表meta的所有成员，表meta就成为了表t的“原型”。
可以通过下面的例子来进一步理解Lua的“原型”操作：
​​local proto = {} &ndash; 首先声明一个原型对象，暂时是空表 function proto.go() &ndash; 为表添加一个方法，即成员函数  print(&ldquo;go pikachu&rdquo;) end local mt = { __index = proto } &ndash; 定义元表，注意重载了“__index” local obj = setmetatable({}, mt) &ndash; 调用setmetatable设置元表，返回新表 obj.go() &ndash; 新对象是原型的“克隆”，可以执行原型的操作​​
代码里的关键操作是定义元表mt，里面只需要设置“__index”方法，然后再使用函数setmetatable从mt克隆出一个新的对象。
这两个步骤也可以合并为一次操作：</p></blockquote></blockquote><blockquote><blockquote><p>Lua为面向对象的方式使用表内成员函数提供一个特殊的操作符“:”，它的功能与“.”基本相同，但在调用函数时会隐含传入一个“self”参数</p></blockquote></blockquote><blockquote><blockquote><p>“:”和self不仅可以用在函数调用时，也可以用在函数定义时</p></blockquote></blockquote><blockquote><blockquote><p>“:”其实是一种“语法糖”，是简化的“.”写法</p></blockquote></blockquote><blockquote><blockquote><p>建议尽量使用“:”，它更简洁一些</p></blockquote></blockquote><blockquote><blockquote><p>应该用OpenResty自己的ngx.re系列函数</p></blockquote></blockquote><blockquote><blockquote><p>过table.insert的效率并不高，我们可以用如下的方式更高效地在末尾添加元素：</p></blockquote></blockquote><blockquote><blockquote><p>a[#a + 1] = &lsquo;nginx&rsquo; &ndash; 利用“#”运算符获取长度来添加元素​​</p></blockquote></blockquote><blockquote><blockquote><p>io库里是操作文件的函数，由于文件通常存储在磁盘上，而且是阻塞操作，速度很慢，在OpenResty里应当尽量少用。</p></blockquote></blockquote><blockquote><blockquote><p>在读取数据时，可以使用参数“*a”（即all）读取整个文件，或者“*l”（即line）读取一行，使用数字则读取指定长度的字节</p></blockquote></blockquote><blockquote><blockquote><p>os库包含有操作系统和时间日期相关的函数</p></blockquote></blockquote><blockquote><blockquote><p>形象（但不很准确）地来说，“闭包”就是一个“活的函数”，存在于程序的“高维空间”，可以任意操作函数外部的数据</p></blockquote></blockquote><blockquote><blockquote><p>如果想要Lua代码更加健壮，我们可以使用保护模式来执行可能出错的函数</p></blockquote></blockquote><blockquote><blockquote><p>pcall（protected call）是base库里的一个特殊函数，它“保护调用”一个函数，绝对不会出错，并以true/false返回调用结果</p></blockquote></blockquote><p>◆ 第4章 LuaJIT环境</p><blockquote><blockquote><p>LuaJIT是Lua语言的另一个实现，包括一个汇编语言编写的解释器和一个JIT编译器</p></blockquote></blockquote><blockquote><blockquote><p>使用“::label::”的形式定义标签，之后就可以随时用goto改变程序的流程</p></blockquote></blockquote><blockquote><blockquote><p>LuaJIT增强了table库，为它添加了一些新函数，其中较有用的有table.new、table.clear和table.clone。</p></blockquote></blockquote><blockquote><blockquote><p>函数table.clear把表置为空表，但保留之前分配的内存</p></blockquote></blockquote><blockquote><blockquote><p>函数table.clone是OpenResty的LuaJIT分支独有特性，可以高效地“浅”拷贝表（shallow clone）</p></blockquote></blockquote><blockquote><blockquote><p>ffi库不仅可以调用系统函数和OpenResty内部的C函数，还可以加载so形式的动态库，调用动态库里的函数</p></blockquote></blockquote><blockquote><blockquote><p>LuaJIT总是先用解释器运行编译后的字节码，并在运行时做“热点分析”，如果某段代码足够“热”，就会自动触发JIT编译器，尝试把字节码再编译成本地的机器码，让程序能够以最快的速度运行。</p></blockquote></blockquote><blockquote><blockquote><p>有的Lua函数因为实现的代价较高所以不会被编译，只能以字节码的形式运行，这些被称为NYI（Not Yet Implemented）。</p></blockquote></blockquote><p>◆ 第5章 开发概述</p><blockquote><blockquote><p>OpenResty提供一个专用指令“content_by_lua_block”，可以在配置文件里书写Lua代码，产生响应内容</p></blockquote></blockquote><blockquote><blockquote><p>启动应用需要使用“-c”参数，让OpenResty以指定的配置文件运行：/usr/local/openresty/bin/openresty -c &ldquo;<code>pwd</code>/hello.conf&rdquo;</p></blockquote></blockquote><blockquote><blockquote><p>5.1节的例子是最简单的OpenResty应用，只有一个配置文件，应用代码写在了配置文件里。但实际的项目要比它复杂很多，配置文件和应用代码最好分离管理维护，此外还会有其他的监控脚本、日志文件、数据文件等，必须要用很好的目录层次把它们组织起来。
通常一个OpenResty应用的目录结构如下：[插图]
​​path/to/application #应用的主目录 ├── bin #脚本目录，存放各种脚本文件 ├── conf #配置目录，存放Nginx配置文件 │ ├── http #存放HTTP服务的配置文件 │ ├── stream #存放TCP/UDP服务的配置文件</p></blockquote></blockquote><blockquote><blockquote><p>在OpenResty里ngx_lua和stream_lua分别属于两个不同的子系统，但指令的功能和格式基本相同</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty目前关注的是initing和running这两个阶段，并做了更细致的划分。</p></blockquote></blockquote><blockquote><blockquote><p>开发者必须较好地理解这些阶段的含义和作用，再结合自己的实际业务需求，选择恰当的阶段编写代码实现功能</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty使用“定时器”来周期性地（一次或多次）执行“后台任务”。</p></blockquote></blockquote><blockquote><blockquote><p>这些接口大部分位于全局表ngx里，无须require即可访问（不过也有部分例外）</p></blockquote></blockquote><blockquote><blockquote><p>与Lua自带的标准库函数不同，它们基于Nginx的事件机制和Lua的协程特性，都是“100% nonblocking”的，能够让我们轻松编写出同步非阻塞的高效代码</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty自带了很多Lua库（位于安装目录的lualib内）, lua-resty-core是其中最重要的一个，它使用ffi重新实现了OpenResty里原有的大多数函数，并增加了一些新的功能。</p></blockquote></blockquote><p>◆ 第6章 基础功能</p><blockquote><blockquote><p>ngx.sleep是OpenResty提供的同步非阻塞的睡眠函数，可以“睡眠”任意的时间长度但不会阻塞整个服务，这时OpenResty会基于协程机制转而处理其他的请求，等睡眠时间到再“回头”继续执行ngx.sleep后续的代码。</p></blockquote></blockquote><blockquote><blockquote><p>MessagePack是一种二进制数据编码格式，与JSON相比更加小巧紧凑，适合序列化传输大批量的数据。</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty在表ngx.re里提供六个正则表达式相关函数，它们的底层实现是PCRE库，速度极快，完全可以代替Lua标准库的字符串匹配函数</p></blockquote></blockquote><blockquote><blockquote><p>正则替换也有两个函数：ngx.re.sub和ngx.re.gsub，我们在使用时最好不要加“o”选项（原因见6.5.2节</p></blockquote></blockquote><blockquote><blockquote><p>ngx.re.gsub是ngx.re.sub的增强版，可以执行多次正则替换</p></blockquote></blockquote><blockquote><blockquote><p>Cache的容量通常都是有限的，需要使用某种算法更新淘汰数据，较常见的有FIFO、LFU、LRU等</p></blockquote></blockquote><blockquote><blockquote><p>OpenResty基于LRU算法提供了一个方便易用的Cache库lua-resty-lru-cache，并且支持过期时间功能（expire）</p></blockquote></blockquote><blockquote><blockquote><p>cache对象的功能接口十分简单易用，提供基本的set/get/delete等操作，用起来就像是一个Key-Value的散列表，缓存内的元素也可以是任何Lua数据（数字、字符串、函数、表等），无须序列化或反序列化</p></blockquote></blockquote><p>◆ 第7章 HTTP服务</p><blockquote><blockquote><p>状态码表示HTTP请求的处理状态，目前RFC规范里有一百多个，在OpenResty里只定义了少量最常见的，</p></blockquote></blockquote><p>◆ 第8章 访问后端</p><blockquote><blockquote><p>必须利用Redis、MySQL等数据库服务存储缓存、会话和其他数据，利用Kafka、RabbitMQ等消息队列服务异步发送消息，以及访问Tomcat、PHP等业务服务，访问ZooKeeper、Consul等配置服务，综合协调这些后端才能为最终用户呈现出一个功能完备的应用服务。</p></blockquote></blockquote><div class=post-meta></hr>注：本作品采用<a rel=license target=view_window href=http://creativecommons.org/licenses/by-nc-sa/4.0/> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议 </a>进行许可。</div></div><footer class=post-footer><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on twitter" href="https://twitter.com/intent/tweet/?text=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b&url=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f&title=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b&summary=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b&source=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f&title=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on whatsapp" href="https://api.whatsapp.com/send?text=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b%20-%20https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [摘录]《OpenResty完全开发指南：构建百万级别并发的Web应用》 - 罗剑锋 on telegram" href="https://telegram.me/share/url?text=%5b%e6%91%98%e5%bd%95%5d%e3%80%8aOpenResty%e5%ae%8c%e5%85%a8%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97%ef%bc%9a%e6%9e%84%e5%bb%ba%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e5%b9%b6%e5%8f%91%e7%9a%84Web%e5%ba%94%e7%94%a8%e3%80%8b%20-%20%e7%bd%97%e5%89%91%e9%94%8b&url=https%3a%2f%2fwww.frytea.com%2farchives%2f678%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><nav class=paginav><a class=prev href=https://www.frytea.com/archives/683/><span class=title>« 上一页</span><br><span>查询谷歌账号注册时间方法（2022）</span></a>
<a class=next href=https://www.frytea.com/archives/690/><span class=title>下一页 »</span><br><span>第一反应要三思</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=songtianlun/songtianlun.github.io data-repo-id=R_kgDOGQ9BVQ data-category=Announcements data-category-id=DIC_kwDOGQ9BVc4CX1qg data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright &copy; 2023 • <a href=https://www.frytea.com/>Frytea</a></span>
<span>• <a href=http://beian.miit.gov.cn/ target=view_window>粤 ICP 备 19144283 号</a></span><div><span><a href=/about/>关于</a>
• <a href=/disclaimer/>免责声明</a>
• <a href=/sitemap.xml target=view_window>站点地图</a>
• <a href=https://www.foreverblog.cn/go.html target=view_window>虫洞</a>
• PV <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><meta name=”apple-mobile-web-app-capable” content="”yes”"><script>'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js')})</script></body></html>